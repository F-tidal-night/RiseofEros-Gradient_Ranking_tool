<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欲神幻想梯度榜</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        :root {
            --primary-pink: #fa67b2;
            --primary-purple: #9d4edd;
            --primary-blue: #5a67d8;
            --light-pink: #ff9fdb;
            --light-purple: #c77dff;
            --light-blue: #8b9dff;
            --bg-gradient: linear-gradient(135deg, #1a0b2e, #0d0630, #0f1b3a);
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-color: #f0e6ff;
            --success-green: #4ade80;
            --warning-orange: #fbbf24;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* 粒子效果容器 */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        /* 顶部标题区域 */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 25px 20px;
            margin-bottom: 30px;
            position: relative;
            background: rgba(154, 80, 221, 0.15);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(250, 103, 178, 0.2);
            border: 2px solid rgba(250, 103, 178, 0.3);
        }

        .header-img {
            height: 180px;
            width: auto;
            object-fit: contain;
        }

        .header-img.left {
            margin-right: 45px;
            height: 200px;
        }

        .header-img.right {
            margin-left: 40px;
            height: 200px;
        }

        .header-title {
            text-align: center;
        }

        .main-title {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary-pink), var(--light-purple), var(--light-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(250, 103, 178, 0.4);
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--light-pink);
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* 数据管理工具栏 */
        .data-toolbar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .data-btn {
            padding: 14px 30px;
            background: linear-gradient(90deg, var(--primary-purple), var(--primary-blue));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            min-width: 180px;
            justify-content: center;
        }

        .data-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(157, 78, 221, 0.4);
        }

        .data-btn.export {
            background: linear-gradient(90deg, #4ade80, #22c55e);
        }

        .data-btn.export:hover {
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.4);
        }

        .data-btn.import {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .data-btn.import:hover {
            box-shadow: 0 10px 20px rgba(217, 119, 6, 0.4);
        }

        .data-btn.official {
            background: linear-gradient(90deg, #ec4899, #db2777);
        }

        .data-btn.official:hover {
            box-shadow: 0 10px 20px rgba(219, 39, 119, 0.4);
        }

        .data-btn.tutorial {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }

        .data-btn.tutorial:hover {
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.4);
        }

        /* 教程模态框 */
        .tutorial-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 20px;
        }

        .tutorial-modal.show {
            display: flex;
        }

        .tutorial-modal-content {
            background: var(--bg-gradient);
            border-radius: 20px;
            border: 2px solid var(--primary-pink);
            width: 90%;
            max-width: 1000px;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }

        .tutorial-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid rgba(250, 103, 178, 0.3);
        }

        .tutorial-modal-header h2 {
            color: var(--light-pink);
            font-size: 2rem;
            margin: 0;
        }

        .tutorial-modal-close {
            background: transparent;
            border: none;
            color: var(--light-pink);
            font-size: 2.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .tutorial-modal-close:hover {
            color: white;
            transform: scale(1.1);
        }

        .tutorial-modal-body {
            padding: 30px;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .tutorial-modal-body h3 {
            color: var(--light-pink);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .tutorial-modal-body p {
            margin-bottom: 15px;
        }

        .tutorial-modal-body ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .tutorial-modal-body li {
            margin-bottom: 8px;
        }

        /* 手动匹配图片模态框 */
        .manual-match-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 20px;
        }

        .manual-match-modal.show {
            display: flex;
        }

        .manual-match-content {
            background: var(--bg-gradient);
            border-radius: 20px;
            border: 2px solid var(--primary-pink);
            width: 95%;
            height: 90%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }

        .manual-match-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(250, 103, 178, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .manual-match-header h3 {
            color: var(--light-pink);
            font-size: 1.8rem;
            margin: 0;
        }

        .manual-match-close {
            background: transparent;
            border: none;
            color: var(--light-pink);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .manual-match-close:hover {
            color: white;
            transform: scale(1.1);
        }

        .manual-match-body {
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .match-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(250, 103, 178, 0.2);
        }

        .match-section h4 {
            color: var(--light-pink);
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-section h4 i {
            color: var(--light-purple);
        }

        /* 角色列表容器 */
        .character-match-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .character-match-container::-webkit-scrollbar {
            width: 6px;
        }

        .character-match-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .character-match-container::-webkit-scrollbar-thumb {
            background: rgba(250, 103, 178, 0.5);
            border-radius: 3px;
        }

        /* 图片列表容器 */
        .image-match-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .image-match-container::-webkit-scrollbar {
            width: 6px;
        }

        .image-match-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .image-match-container::-webkit-scrollbar-thumb {
            background: rgba(250, 103, 178, 0.5);
            border-radius: 3px;
        }

        /* 角色匹配项 */
        .character-match-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 2px solid rgba(250, 103, 178, 0.2);
            transition: all 0.3s;
        }

        .character-match-item:hover {
            background: rgba(250, 103, 178, 0.1);
            border-color: rgba(250, 103, 178, 0.4);
        }

        .character-match-item.selected {
            background: rgba(250, 103, 178, 0.15);
            border-color: var(--primary-pink);
            box-shadow: 0 0 15px rgba(250, 103, 178, 0.3);
        }

        .character-match-avatar {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .character-match-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .character-match-info {
            flex: 1;
            min-width: 0;
        }

        .character-match-name {
            font-weight: 600;
            color: var(--light-pink);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .character-match-stats {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--light-purple);
        }

        .character-match-select {
            flex-shrink: 0;
            padding: 8px 15px;
            background: rgba(90, 103, 216, 0.3);
            border: 1px solid rgba(90, 103, 216, 0.5);
            border-radius: 8px;
            color: var(--light-blue);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .character-match-select:hover {
            background: rgba(90, 103, 216, 0.5);
        }

        /* 图片匹配项 */
        .image-match-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
            border: 2px solid rgba(250, 103, 178, 0.2);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .image-match-item:hover {
            border-color: rgba(250, 103, 178, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .image-match-item.selected {
            border-color: var(--primary-pink);
            box-shadow: 0 0 15px rgba(250, 103, 178, 0.3);
        }

        .image-match-preview {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-match-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-match-name {
            font-size: 0.85rem;
            color: var(--text-color);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 匹配控制区域 */
        .match-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-top: 1px solid rgba(250, 103, 178, 0.2);
            flex-shrink: 0;
        }

        .match-filter {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(250, 103, 178, 0.3);
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: rgba(250, 103, 178, 0.2);
        }

        .filter-btn.active {
            background: linear-gradient(90deg, var(--primary-pink), var(--primary-purple));
        }

        .match-actions {
            display: flex;
            gap: 15px;
        }

        .match-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .match-btn.apply {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: white;
        }

        .match-btn.apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .match-btn.cancel {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            color: #ff9999;
        }

        .match-btn.cancel:hover {
            background: rgba(255, 100, 100, 0.4);
        }

        /* 图片选择模态框 */
        .image-select-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10002;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .image-select-modal.show {
            display: flex;
        }

        .image-select-content {
            background: var(--bg-gradient);
            border-radius: 20px;
            border: 2px solid var(--primary-pink);
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
        }

        .image-select-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(250, 103, 178, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .image-select-header h4 {
            color: var(--light-pink);
            font-size: 1.5rem;
            margin: 0;
        }

        .image-select-close {
            background: transparent;
            border: none;
            color: var(--light-pink);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .image-select-close:hover {
            color: white;
            transform: scale(1.1);
        }

        .image-select-body {
            padding: 20px 30px;
            overflow-y: auto;
        }

        .image-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .image-select-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
            border: 2px solid rgba(250, 103, 178, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-select-item:hover {
            border-color: rgba(250, 103, 178, 0.4);
            transform: translateY(-3px);
        }

        .image-select-item.selected {
            border-color: var(--primary-pink);
            box-shadow: 0 0 15px rgba(250, 103, 178, 0.3);
        }

        .image-select-preview {
            width: 100%;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-select-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-select-name {
            font-size: 0.8rem;
            color: var(--text-color);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-select-footer {
            padding: 20px 30px;
            border-top: 2px solid rgba(250, 103, 178, 0.3);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .image-select-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .image-select-btn.confirm {
            background: linear-gradient(90deg, #4ade80, #22c55e);
            color: white;
        }

        .image-select-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .image-select-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(250, 103, 178, 0.3);
            color: var(--text-color);
        }

        .image-select-btn.cancel:hover {
            background: rgba(250, 103, 178, 0.2);
        }

        /* 处理中覆盖层 */
        .processing-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10002;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .processing-overlay.show {
            display: flex;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(250, 103, 178, 0.3);
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 1.2rem;
            color: var(--light-pink);
            margin-bottom: 10px;
        }

        .processing-subtext {
            color: var(--light-purple);
            font-size: 0.9rem;
        }

        /* 通用框样式 */
        .section-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(250, 103, 178, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .section-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-pink), var(--primary-purple), var(--primary-blue));
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--light-pink);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(250, 103, 178, 0.3);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            font-size: 1.5rem;
        }

        /* 创建角色表单 */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 8px;
            color: var(--light-purple);
            font-weight: 500;
        }

        .form-input, .form-textarea {
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid rgba(250, 103, 178, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-select {
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid rgba(250, 103, 178, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-select option {
            color: #9d4edd;
            background: rgba(20, 10, 40, 0.95);
        }

        .form-select option:hover {
            background: rgba(157, 78, 221, 0.3);
        }

        .form-select option:checked {
            background: rgba(157, 78, 221, 0.5);
            color: #ffffff;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 15px rgba(250, 103, 178, 0.4);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .image-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(250, 103, 178, 0.5);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
        }

        .image-upload-container:hover {
            border-color: var(--primary-pink);
            background: rgba(250, 103, 178, 0.1);
        }

        .image-upload-container i {
            font-size: 2.5rem;
            color: var(--light-pink);
            margin-bottom: 10px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .create-button {
            grid-column: 1 / -1;
            padding: 15px 30px;
            background: linear-gradient(90deg, var(--primary-pink), var(--primary-purple));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            letter-spacing: 1px;
        }

        .create-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(250, 103, 178, 0.4);
        }

        .create-button:disabled {
            background: linear-gradient(90deg, #888, #999);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 配队模拟区域 */
        .team-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .team-tabs {
            display: flex;
            gap: 10px;
        }

        .team-tab {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(250, 103, 178, 0.3);
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .team-tab:hover {
            background: rgba(250, 103, 178, 0.2);
        }

        .team-tab.active {
            background: linear-gradient(90deg, var(--primary-pink), var(--primary-purple));
            font-weight: 600;
        }

        .clear-team-btn {
            padding: 8px 20px;
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 20px;
            color: #ff9999;
            cursor: pointer;
            transition: all 0.3s;
        }

        .clear-team-btn:hover {
            background: rgba(255, 100, 100, 0.4);
        }

        .team-slots-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            min-height: 400px;
        }

        .team-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(250, 103, 178, 0.4);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 380px;
            transition: all 0.3s;
        }

        .team-slot.drop-over {
            border-color: var(--primary-pink);
            background: rgba(250, 103, 178, 0.1);
            transform: scale(1.02);
        }

        .slot-placeholder {
            color: rgba(250, 103, 178, 0.6);
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
        }

        .slot-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        /* 角色卡片样式 */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .character-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            overflow: visible;
            transition: all 0.3s;
            position: relative;
            height: 420px;
            width: 260px;
            margin: 0 auto;
            border: 1px solid rgba(250, 103, 178, 0.2);
            backdrop-filter: blur(5px);
        }

        .character-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(250, 103, 178, 0.25);
            border-color: rgba(250, 103, 178, 0.5);
        }

        .character-card.hidden-card {
            opacity: 0.6;
        }

        .card-image-container {
            width: 100%;
            height: 260px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .card-image {
            width: auto;
            height: 100%;
            max-width: 100%;
            object-fit: contain;
            transition: transform 0.5s;
        }

        .character-card:hover .card-image {
            transform: scale(1.05);
        }

        .card-content {
            padding: 15px;
            position: relative;
        }

        .card-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--light-pink);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-stars {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            gap: 2px;
        }

        .star-icon {
            color: #ccc;
            font-size: 1.2rem;
        }

        .star-icon.filled {
            color: #ffd700;
        }

        .card-scores {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .pve-score {
            color: var(--light-blue);
        }

        .pvp-score {
            color: var(--light-purple);
        }

        .card-review-toggle {
            background: rgba(250, 103, 178, 0.1);
            border: none;
            color: var(--light-purple);
            padding: 8px 12px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
            position: relative;
        }

        .card-review-toggle:hover {
            background: rgba(250, 103, 178, 0.2);
        }

        /* 角色评价浮动框 - 重新设计 */
        .card-review-popup {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: rgba(20, 10, 40, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            width: calc(100% + 40px);
            min-width: 280px;
            max-width: 320px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(250, 103, 178, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
        }

        .card-review-popup::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: rgba(250, 103, 178, 0.4) transparent transparent transparent;
        }

        .card-review-popup::after {
            content: '';
            position: absolute;
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 7px;
            border-style: solid;
            border-color: rgba(20, 10, 40, 0.95) transparent transparent transparent;
        }

        .card-review-popup.expanded {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-100%);
        }

        .card-review-content {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-color);
        }

        .card-review-content::-webkit-scrollbar {
            width: 6px;
        }

        .card-review-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .card-review-content::-webkit-scrollbar-thumb {
            background: rgba(250, 103, 178, 0.5);
            border-radius: 3px;
        }

        .card-review-content::-webkit-scrollbar-thumb:hover {
            background: rgba(250, 103, 178, 0.7);
        }

        .card-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .character-card:hover .card-actions {
            opacity: 1;
        }

        .card-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .edit-btn {
            background: rgba(90, 103, 216, 0.9);
            color: white;
        }

        .delete-btn {
            background: rgba(250, 103, 178, 0.9);
            color: white;
        }

        .hide-btn {
            background: rgba(157, 78, 221, 0.9);
            color: white;
        }

        .show-btn {
            background: rgba(157, 78, 221, 0.9);
            color: white;
        }

        /* 搜索和排序控件 */
        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex-grow: 1;
            max-width: 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border-radius: 25px;
            border: 2px solid rgba(250, 103, 178, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 15px rgba(250, 103, 178, 0.4);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-pink);
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(250, 103, 178, 0.3);
            border-radius: 20px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sort-btn:hover {
            background: rgba(250, 103, 178, 0.2);
        }

        .sort-btn.active {
            background: linear-gradient(90deg, var(--primary-pink), var(--primary-purple));
            font-weight: 600;
        }

        /* 隐藏角色区域 */
        .hidden-section {
            margin-top: 20px;
        }

        .toggle-hidden-btn {
            padding: 12px 25px;
            background: linear-gradient(90deg, var(--primary-purple), var(--primary-blue));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .toggle-hidden-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(157, 78, 221, 0.4);
        }

        .hidden-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .hidden-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(250, 103, 178, 0.3);
            display: none;
        }

        .hidden-cards-container.expanded {
            display: grid;
        }

        /* 导入文件输入 */
        .import-file-input {
            display: none;
        }

        /* 消息提示 */
        .message-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: rgba(20, 10, 40, 0.95);
            border-left: 5px solid var(--success-green);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .message-toast.show {
            transform: translateX(0);
        }

        .message-toast.error {
            border-left-color: #ef4444;
        }

        .message-toast.warning {
            border-left-color: var(--warning-orange);
        }

        /* 页脚 */
        footer {
            text-align: center;
            padding: 25px 0;
            margin-top: 30px;
            color: var(--light-pink);
            font-size: 1rem;
            border-top: 1px solid rgba(250, 103, 178, 0.3);
        }

        /* 发光/呼吸特效 */
        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--primary-pink)); }
            50% { filter: drop-shadow(0 0 15px var(--primary-pink)) drop-shadow(0 0 25px var(--light-purple)); }
        }

        .glow-effect {
            animation: glow 2s infinite alternate;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .breathe-effect {
            animation: breathe 3s infinite ease-in-out;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .team-slots-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .data-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-btn {
                min-width: auto;
            }
            
            .manual-match-body {
                padding: 15px;
            }
            
            .character-match-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
            }
            
            .header-img.left, .header-img.right {
                margin: 10px 0;
            }
            
            .main-title {
                font-size: 2.5rem;
            }
            
            .team-slots-container {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .card-review-popup {
                width: calc(100% + 20px);
                max-width: 280px;
            }
            
            .match-controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .match-filter, .match-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- 粒子效果容器 -->
    <div id="particles-js"></div>

    <!-- 顶部标题区域 -->
    <div class="header-container">
        <img src="./images/picture1.png" alt="左装饰图" class="header-img left glow-effect">
        <div class="header-title">
            <h1 class="main-title breathe-effect">欲神幻想梯度榜</h1>
            <p class="subtitle">FTN工作室出品·高度自定义设计</p>
        </div>
        <img src="./images/picture2.png" alt="右装饰图" class="header-img right glow-effect">
    </div>

    <!-- 数据管理工具栏 -->
    <div class="data-toolbar">
        <button id="exportDataBtn" class="data-btn export">
            <i class="fas fa-file-export"></i> 导出数据
        </button>
        <button id="importDataBtn" class="data-btn import">
            <i class="fas fa-file-import"></i> 导入数据
        </button>
        <button id="importOfficialImagesBtn" class="data-btn official">
            <i class="fas fa-images"></i> 批量导入角色图片
        </button>
        <button id="showTutorialBtn" class="data-btn tutorial">
            <i class="fas fa-book"></i> 使用教程
        </button>
        <input type="file" id="importFileInput" class="import-file-input" accept=".json">
        <input type="file" id="importOfficialImagesInput" class="import-file-input" accept="image/*" multiple>
    </div>

    <!-- 创建角色区域 -->
    <div class="section-container">
        <h2 class="section-title"><i class="fas fa-plus-circle"></i>创建角色</h2>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">角色名字</label>
                <input type="text" id="characterName" class="form-input" placeholder="例如：露妃-墨染金香">
            </div>
            
            <div class="form-group">
                <label class="form-label">角色星级</label>
                <select id="characterStars" class="form-select">
                    <option value="">请选择星级</option>
                    <option value="0">0星</option>
                    <option value="1">1星</option>
                    <option value="2">2星</option>
                    <option value="3">3星</option>
                    <option value="4">4星</option>
                    <option value="5">5星</option>
                    <option value="6">6星</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">PVE评分</label>
                <select id="characterPve" class="form-select">
                    <option value="">请选择PVE评分</option>
                    <option value="0">0分</option>
                    <option value="1">1分</option>
                    <option value="2">2分</option>
                    <option value="3">3分</option>
                    <option value="4">4分</option>
                    <option value="5">5分</option>
                    <option value="6">6分</option>
                    <option value="7">7分</option>
                    <option value="8">8分</option>
                    <option value="9">9分</option>
                    <option value="10">10分</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">PVP评分</label>
                <select id="characterPvp" class="form-select">
                    <option value="">请选择PVP评分</option>
                    <option value="0">0分</option>
                    <option value="1">1分</option>
                    <option value="2">2分</option>
                    <option value="3">3分</option>
                    <option value="4">4分</option>
                    <option value="5">5分</option>
                    <option value="6">6分</option>
                    <option value="7">7分</option>
                    <option value="8">8分</option>
                    <option value="9">9分</option>
                    <option value="10">10分</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">角色评价</label>
                <textarea id="characterReview" class="form-textarea" placeholder="请输入角色评价..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">角色图片（可选）</label>
                <div id="imageUpload" class="image-upload-container">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>点击或拖拽上传图片</p>
                    <p class="subtitle" style="font-size: 0.9rem; margin-top: 5px;">推荐尺寸: 350x406</p>
                    <p class="subtitle" style="font-size: 0.9rem; color: var(--light-pink);">不上传则会使用默认图片</p>
                    <img id="imagePreview" class="image-preview" alt="图片预览">
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
            
            <button id="createButton" class="create-button" disabled>创建角色</button>
        </div>
    </div>

    <!-- 配队模拟区域 -->
    <div class="section-container">
        <div class="team-controls">
            <h2 class="section-title" style="margin-bottom: 0;"><i class="fas fa-users"></i>配队模拟</h2>
            <div>
                <div class="team-tabs">
                    <button class="team-tab active" data-team="1">队伍1</button>
                    <button class="team-tab" data-team="2">队伍2</button>
                    <button class="team-tab" data-team="3">队伍3</button>
                    <button class="team-tab" data-team="4">队伍4</button>
                </div>
            </div>
            <button class="clear-team-btn">清空当前配队</button>
        </div>
        
        <div class="team-slots-container" id="teamSlots">
            <div class="team-slot" data-slot="1">
                <div class="slot-placeholder">
                    <i class="fas fa-user-plus"></i>
                    <p>拖拽角色卡片到这里</p>
                </div>
            </div>
            <div class="team-slot" data-slot="2">
                <div class="slot-placeholder">
                    <i class="fas fa-user-plus"></i>
                    <p>拖拽角色卡片到这里</p>
                </div>
            </div>
            <div class="team-slot" data-slot="3">
                <div class="slot-placeholder">
                    <i class="fas fa-user-plus"></i>
                    <p>拖拽角色卡片到这里</p>
                </div>
            </div>
            <div class="team-slot" data-slot="4">
                <div class="slot-placeholder">
                    <i class="fas fa-user-plus"></i>
                    <p>拖拽角色卡片到这里</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 我的角色区域 -->
    <div class="section-container">
        <div class="controls-container">
            <h2 class="section-title" style="margin-bottom: 0;"><i class="fas fa-id-card"></i>我的角色</h2>
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="搜索角色名字...">
            </div>
            <div class="sort-buttons">
                <button class="sort-btn" data-sort="stars">
                    <i class="fas fa-star"></i> 按星级排序
                </button>
                <button class="sort-btn" data-sort="pve">
                    <i class="fas fa-shield-alt"></i> 按PVE排序
                </button>
                <button class="sort-btn" data-sort="pvp">
                    <i class="fas fa-crosshairs"></i> 按PVP排序
                </button>
            </div>
        </div>
        
        <div class="cards-container" id="myCharacters">
            <!-- 角色卡片将通过JS动态生成 -->
        </div>
    </div>

    <!-- 被隐藏的角色区域 -->
    <div class="section-container">
        <button id="toggleHiddenBtn" class="toggle-hidden-btn">
            <span>查看被隐藏的角色</span>
            <span class="hidden-count" id="hiddenCount">0</span>
        </button>
        
        <div class="hidden-cards-container" id="hiddenCharacters">
            <!-- 隐藏的角色卡片将通过JS动态生成 -->
        </div>
    </div>

    <!-- 页脚 -->
    <footer>
        欲神幻想梯度榜 v1.5 · FTN工作室出品 · 新增批量导入图片功能
    </footer>

    <!-- 教程模态框 -->
    <div id="tutorialModal" class="tutorial-modal">
        <div class="tutorial-modal-content">
            <div class="tutorial-modal-header">
                <h2>使用教程</h2>
                <button class="tutorial-modal-close">&times;</button>
            </div>
            <div class="tutorial-modal-body" id="tutorialContent">
                <h3>欢迎使用欲神幻想梯度榜</h3>
                <p>本工具由FTN工作室开发，为广大玩家提供便利的角色强度整理及配队模拟。</p>
                
                <h3>主要功能</h3>
                <ul>
                    <li><strong>创建角色</strong>：添加角色，设置突破星级、PVE/PVP评分、评价</li>
                    <li><strong>配队模拟</strong>：拖拽角色卡片模拟游戏内的配队</li>
                    <li><strong>搜索排序</strong>：通过关键词搜索角色、按星级、PVE/PVP评分自动排序</li>
                    <li><strong>数据管理</strong>：导入/导出数据，与他人互相分享卡片，备份自己的数据</li>
                    <li><strong>批量导出图片</strong>：通过导入多个图片来快速为卡片添加/更新角色图片</li>
                </ul>
                
                <h3>详细使用说明</h3>
                <h4>1. 创建角色</h4>
                <p>填写角色相关信息以创建卡片：</p>
                <ul>
                    <li><strong>角色名字</strong>：推荐按照示例格式填写，方便对照标准图包</li>
                    <li><strong>角色星级</strong>：按照自己账号内角色练度填写即可</li>
                    <li><strong>PVE/PVP评分</strong>：虽然给了0~10分的范围，但是可根据需求限制最高分</li>
                    <li><strong>角色评价</strong>：非必填，可对角色自由评价备注</li>
                    <li><strong>角色图片</strong>：非必填，上传尺寸350x406的图片最佳，如未填写，将使用默认图</li>
                </ul>
                
                <h4>2. 配队模拟</h4>
                <p>提供更好的配队预览体验：</p>
                <ul>
                    <li><strong>切换队伍</strong>：点击上方标签切换不同队伍</li>
                    <li><strong>添加角色</strong>：从“我的角色”区域拖拽卡片到队伍虚线框中</li>
                    <li><strong>移除角色</strong>：点击队伍中卡片右上角的移除按钮，或拖拽回“我的角色”区域亦可</li>
                    <li><strong>清空队伍</strong>：点击右上角“清空当前配队”按钮即可一键清空当前选中的队伍</li>
                </ul>
                
                <h4>3. 管理角色</h4>
                <p>浏览你创建的角色以及其强度信息：</p>
                <ul>
<li><strong>编辑</strong>：点击角色卡片右上角编辑按钮即可修改角色信息，修改完记得点击按钮保存</li>
                    <li><strong>删除</strong>：点击删除按钮后确认操作即可删除该卡片</li>
                    <li><strong>隐藏</strong>：点击隐藏按钮即可将卡片移至底部折叠栏</li>
                    <li><strong>查看评价</strong>：点击卡片下方“角色评价”按钮即可展开/收起评价内容</li>
                </ul>
                
                <h4>4. 搜索与排序</h4>
                <ul>
                    <li><strong>搜索</strong>：在搜索框输入角色名字即可自动筛选所需角色卡片</li>
                    <li><strong>排序</strong>：点击按钮即可按对应信息从高到低排序，再次点击取消排序</li>
                </ul>
                
                <h4>5. 数据管理</h4>
                <ul>
                    <li><strong>导出数据</strong>：点击“导出数据”按钮，浏览器会自动下载json格式的数据文件（不包括角色图），标注有创建时间</li>
                    <li><strong>导入数据</strong>：点击“导入数据”按钮，选择正确的json格式文件即可获得数据（不包括角色图），导入前注意备份</li>
                    <li><strong>数据自动保存</strong>：创建好的角色卡片数据会自动保存到本地，无需点击任何东西</li>
                </ul>
                
                <h4>6. 批量导入角色图片（手动匹配）</h4>
                <p>为多个卡片缺少图片时提供更便利、清晰的操作：</p>
                <ul>
                    <li><strong>准备图片</strong>：群内下载FTN工作室提供的标准全角色图压缩包，或百度网盘https://pan.baidu.com/s/1n4iy_olBixNX7lc-CJ8Xbg?pwd=0114</li>
                    <li><strong>导入图片</strong>：可按需求多选图片，推荐按角色本名分批处理更清晰，一次全导入可能出现卡顿/报错问题</li>
                    <li><strong>匹配图片</strong>：可选所有角色/仅无图片角色来添加角色图片，添加完毕后记得左下角应用更改哦
                        </ul>
                
                <h4>7. 常见问题</h4>
                <ul>
                    <li><strong>图片上传失败</strong>：请检查图片尺寸及格式（支持jpg、png等常见格式）</li>
                    <li><strong>批量导入失败</strong>：请检查图片是否损坏，若无损坏请尝试减少单次导入量</li>
                    <li><strong>数据丢失</strong>：更换/清理浏览器或更换设备前请先导出数据，数据保存依赖于浏览器</li>
                </ul>
                
                <h3>注意事项</h3>
                <ul>
                    <li>推荐使用chorme、Edge等稳定浏览器</li>
                    <li>请勿随意修改官方图包，以防数据损坏</li>
                    <li>本文件夹内所有原始文件版权归“FTN工作室”所有</li>
                    <li>本工具无偿分享！严禁二次兜售！违者死全家！</li>
                </ul>
                
                <p>如有问题或建议，请在群内@F-tidal night</p>
            </div>
        </div>
    </div>

    <!-- 手动匹配图片模态框 -->
    <div id="manualMatchModal" class="manual-match-modal">
        <div class="manual-match-content">
            <div class="manual-match-header">
                <h3>手动匹配角色图片</h3>
                <button class="manual-match-close">&times;</button>
            </div>
            <div class="manual-match-body">
                <div class="match-section">
                    <h4><i class="fas fa-users"></i>角色列表 <span id="characterCount">(0)</span></h4>
                    <div class="match-filter">
                        <button class="filter-btn active" data-filter="all">所有角色</button>
                        <button class="filter-btn" data-filter="no-image">仅无图片角色</button>
                    </div>
                    <div class="character-match-container" id="characterMatchList">
                        <!-- 角色列表将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="match-section">
                    <h4><i class="fas fa-images"></i>已选择的图片 <span id="imageCount">(0)</span></h4>
                    <div class="image-match-container" id="imageMatchList">
                        <!-- 图片列表将通过JS动态生成 -->
                    </div>
                </div>
            </div>
            <div class="match-controls">
                <div class="match-actions">
                    <button class="match-btn apply" id="applyMatches">应用更改</button>
                    <button class="match-btn cancel" id="cancelMatch">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片选择模态框 -->
    <div id="imageSelectModal" class="image-select-modal">
        <div class="image-select-content">
            <div class="image-select-header">
                <h4 id="imageSelectTitle">为【角色名】选择图片</h4>
                <button class="image-select-close">&times;</button>
            </div>
            <div class="image-select-body">
                <div class="image-select-grid" id="imageSelectGrid">
                    <!-- 图片选择项将通过JS动态生成 -->
                </div>
            </div>
            <div class="image-select-footer">
                <button class="image-select-btn confirm" id="confirmImageSelect">确认选择</button>
                <button class="image-select-btn cancel" id="cancelImageSelect">取消</button>
            </div>
        </div>
    </div>

    <!-- 处理中覆盖层 -->
    <div class="processing-overlay" id="globalProcessingOverlay">
        <div class="processing-spinner"></div>
        <div class="processing-text">正在处理中...</div>
        <div class="processing-subtext" id="globalProcessingStatus">请稍候</div>
    </div>

    <!-- 消息提示 -->
    <div id="messageToast" class="message-toast"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // 初始化粒子效果
        document.addEventListener('DOMContentLoaded', function() {
            particlesJS("particles-js", {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: "#fa67b2" },
                    shape: { type: "circle" },
                    opacity: { value: 0.5, random: true },
                    size: { value: 3, random: true },
                    line_linked: {
                        enable: true,
                        distance: 150,
                        color: "#9d4edd",
                        opacity: 0.3,
                        width: 1
                    },
                    move: { enable: true, speed: 2, direction: "none", random: true }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "repulse" },
                        onclick: { enable: true, mode: "push" }
                    }
                }
            });
            
            // 初始化应用
            initApp();
        });

        // 应用状态管理
        const state = {
            characters: [],
            hiddenCharacters: [],
            teams: [[], [], [], []],
            currentTeam: 1,
            editingCharacterId: null,
            currentSort: null,
            sortDirection: 'desc'
        };

        // 默认图片路径
        const DEFAULT_IMAGE_PATH = './images/normal.png';
        
        // 图片匹配相关状态
        const matchState = {
            currentImageFiles: [],
            characterMatches: new Map(), // 角色ID -> 图片数据
            selectedCharacterId: null,
            selectedImageIndex: null,
            currentFilter: 'all'
        };

        // 初始化应用
        function initApp() {
            loadFromLocalStorage();
            setupEventListeners();
            renderCharacters();
            updateHiddenCount();
            renderTeams();
            
            // 检查必填字段
            checkRequiredFields();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 图片上传
            document.getElementById('imageUpload').addEventListener('click', () => {
                document.getElementById('imageInput').click();
            });
            
            document.getElementById('imageInput').addEventListener('change', function(e) {
                handleImageUpload(e.target.files[0]);
            });
            
            // 拖拽上传图片
            document.getElementById('imageUpload').addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#fa67b2';
            });
            
            document.getElementById('imageUpload').addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = 'rgba(250, 103, 178, 0.5)';
            });
            
            document.getElementById('imageUpload').addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = 'rgba(250, 103, 178, 0.5)';
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // 创建/修改角色按钮
            document.getElementById('createButton').addEventListener('click', createOrUpdateCharacter);
            
            // 必填字段检查（图片不再是必填项）
            ['characterName', 'characterStars', 'characterPve', 'characterPvp'].forEach(id => {
                document.getElementById(id).addEventListener('change', checkRequiredFields);
                document.getElementById(id).addEventListener('input', checkRequiredFields);
            });
            
            // 搜索框
            document.getElementById('searchInput').addEventListener('input', renderCharacters);
            
            // 排序按钮
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sortType = this.dataset.sort;
                    toggleSort(sortType);
                });
            });
            
            // 队伍切换
            document.querySelectorAll('.team-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const teamNum = parseInt(this.dataset.team);
                    switchTeam(teamNum);
                });
            });
            
            // 清空当前队伍
            document.querySelector('.clear-team-btn').addEventListener('click', clearCurrentTeam);
            
            // 显示/隐藏被隐藏的角色
            document.getElementById('toggleHiddenBtn').addEventListener('click', function() {
                const container = document.getElementById('hiddenCharacters');
                container.classList.toggle('expanded');
                this.querySelector('span:first-child').textContent = 
                    container.classList.contains('expanded') ? '隐藏被隐藏的角色' : '查看被隐藏的角色';
            });
            
            // 拖拽功能设置
            setupDragAndDrop();
            
            // 使用事件委托处理卡片按钮点击
            setupEventDelegation();
            
            // 数据管理功能
            setupDataManagement();
            
            // 教程功能
            setupTutorial();
            
            // 手动匹配功能
            setupManualMatch();
        }

        // 设置数据管理事件监听器
        function setupDataManagement() {
            // 导出数据
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            
            // 导入数据
            document.getElementById('importDataBtn').addEventListener('click', function() {
                document.getElementById('importFileInput').click();
            });
            
            document.getElementById('importFileInput').addEventListener('change', importData);
            
            // 批量导入图片
            document.getElementById('importOfficialImagesBtn').addEventListener('click', function() {
                document.getElementById('importOfficialImagesInput').click();
            });
            
            document.getElementById('importOfficialImagesInput').addEventListener('change', handleBatchImagesFileSelect);
        }

        // 设置教程功能
        function setupTutorial() {
            // 教程按钮
            document.getElementById('showTutorialBtn').addEventListener('click', showTutorial);
            
            // 关闭教程模态框
            document.querySelector('.tutorial-modal-close').addEventListener('click', hideTutorial);
            document.getElementById('tutorialModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideTutorial();
                }
            });
        }

        // 设置手动匹配功能
        function setupManualMatch() {
            // 关闭手动匹配模态框
            document.querySelector('.manual-match-close').addEventListener('click', hideManualMatch);
            document.getElementById('manualMatchModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideManualMatch();
                }
            });
            
            // 取消匹配
            document.getElementById('cancelMatch').addEventListener('click', hideManualMatch);
            
            // 应用匹配
            document.getElementById('applyMatches').addEventListener('click', applyCharacterMatches);
            
            // 筛选按钮
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    setCharacterFilter(filter);
                });
            });
            
            // 图片选择模态框
            setupImageSelectModal();
        }

        // 设置图片选择模态框
        function setupImageSelectModal() {
            // 关闭图片选择模态框
            document.querySelector('.image-select-close').addEventListener('click', hideImageSelectModal);
            document.getElementById('imageSelectModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideImageSelectModal();
                }
            });
            
            // 取消图片选择
            document.getElementById('cancelImageSelect').addEventListener('click', hideImageSelectModal);
            
            // 确认图片选择
            document.getElementById('confirmImageSelect').addEventListener('click', confirmImageSelection);
        }

        // 显示教程
        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('show');
        }

        // 隐藏教程
        function hideTutorial() {
            document.getElementById('tutorialModal').classList.remove('show');
        }

        // 显示手动匹配模态框
        function showManualMatch() {
            if (matchState.currentImageFiles.length === 0) {
                showMessage('请先选择图片文件', 'error');
                return;
            }
            
            // 重置匹配状态
            matchState.characterMatches.clear();
            matchState.selectedCharacterId = null;
            matchState.selectedImageIndex = null;
            matchState.currentFilter = 'all';
            
            // 更新筛选按钮
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === matchState.currentFilter);
            });
            
            // 渲染角色匹配列表
            renderCharacterMatchList();
            
            // 渲染图片匹配列表
            renderImageMatchList();
            
            // 显示模态框
            document.getElementById('manualMatchModal').classList.add('show');
        }

        // 隐藏手动匹配模态框
        function hideManualMatch() {
            document.getElementById('manualMatchModal').classList.remove('show');
            matchState.currentImageFiles = [];
            document.getElementById('importOfficialImagesInput').value = '';
        }

        // 显示图片选择模态框
        function showImageSelectModal(characterId, characterName) {
            if (!characterId || matchState.currentImageFiles.length === 0) return;
            
            matchState.selectedCharacterId = characterId;
            document.getElementById('imageSelectTitle').textContent = `为【${characterName}】选择图片`;
            
            // 渲染图片选择网格
            renderImageSelectGrid();
            
            // 显示模态框
            document.getElementById('imageSelectModal').classList.add('show');
        }

        // 隐藏图片选择模态框
        function hideImageSelectModal() {
            document.getElementById('imageSelectModal').classList.remove('show');
            matchState.selectedCharacterId = null;
            matchState.selectedImageIndex = null;
            
            // 清除选择
            document.querySelectorAll('.image-select-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // 显示处理中覆盖层
        function showProcessing(message = '正在处理中...', submessage = '请稍候') {
            const overlay = document.getElementById('globalProcessingOverlay');
            const text = overlay.querySelector('.processing-text');
            const subtext = overlay.querySelector('.processing-subtext');
            
            text.textContent = message;
            subtext.textContent = submessage;
            overlay.classList.add('show');
        }

        // 隐藏处理中覆盖层
        function hideProcessing() {
            document.getElementById('globalProcessingOverlay').classList.remove('show');
        }

        // 显示消息提示
        function showMessage(message, type = 'success') {
            const toast = document.getElementById('messageToast');
            toast.textContent = message;
            toast.className = 'message-toast';
            toast.classList.add(type);
            
            // 显示
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 处理图片上传
        function handleImageUpload(file) {
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showMessage('请上传图片文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // 处理批量图片文件选择
        function handleBatchImagesFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // 过滤出图片文件
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showMessage('请选择图片文件', 'error');
                event.target.value = '';
                return;
            }
            
            if (imageFiles.length > 100) {
                showMessage('选择的图片文件数量过多，建议分批导入', 'warning');
                // 只取前100个
                matchState.currentImageFiles = imageFiles.slice(0, 100);
            } else {
                matchState.currentImageFiles = imageFiles;
            }
            
            // 显示手动匹配界面
            showManualMatch();
        }

        // 读取图片文件为Base64
        function readImageAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 获取文件名（不含扩展名）
                    const fileName = file.name.replace(/\.[^/.]+$/, '');
                    resolve({
                        name: fileName,
                        dataUrl: e.target.result,
                        file: file
                    });
                };
                reader.onerror = function(e) {
                    reject(new Error(`读取图片 ${file.name} 失败`));
                };
                reader.readAsDataURL(file);
            });
        }

        // 渲染角色匹配列表
        function renderCharacterMatchList() {
            const container = document.getElementById('characterMatchList');
            const countElement = document.getElementById('characterCount');
            
            // 获取所有角色（包括隐藏角色）
            const allCharacters = [...state.characters, ...state.hiddenCharacters];
            
            // 根据筛选条件过滤角色
            let filteredCharacters = allCharacters;
            if (matchState.currentFilter === 'no-image') {
                filteredCharacters = allCharacters.filter(character => 
                    !character.image || character.image === DEFAULT_IMAGE_PATH
                );
            }
            
            // 更新计数
            countElement.textContent = `(${filteredCharacters.length})`;
            
            // 生成HTML
            container.innerHTML = filteredCharacters.map((character, index) => {
                const isSelected = matchState.selectedCharacterId === character.id;
                const matchedImage = matchState.characterMatches.get(character.id);
                
                return `
                    <div class="character-match-item ${isSelected ? 'selected' : ''}" data-id="${character.id}">
                        <div class="character-match-avatar">
                            ${matchedImage ? 
                                `<img src="${matchedImage.dataUrl}" alt="${character.name}">` :
                                (character.image && character.image !== DEFAULT_IMAGE_PATH ? 
                                    `<img src="${character.image}" alt="${character.name}">` :
                                    `<i class="fas fa-user" style="color: var(--light-purple); font-size: 2rem;"></i>`
                                )
                            }
                        </div>
                        <div class="character-match-info">
                            <div class="character-match-name">${character.name}</div>
                            <div class="character-match-stats">
                                <span>${character.stars}★</span>
                                <span>PVE: ${character.pve}</span>
                                <span>PVP: ${character.pvp}</span>
                            </div>
                        </div>
                        <button class="character-match-select" data-id="${character.id}">
                            ${matchedImage ? '更换图片' : '选择图片'}
                        </button>
                    </div>
                `;
            }).join('');
            
            // 添加事件监听器
            container.querySelectorAll('.character-match-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (!e.target.closest('.character-match-select')) {
                        const id = this.dataset.id;
                        selectCharacterForMatch(id);
                    }
                });
            });
            
            container.querySelectorAll('.character-match-select').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.dataset.id;
                    const character = [...state.characters, ...state.hiddenCharacters].find(c => c.id === id);
                    if (character) {
                        showImageSelectModal(id, character.name);
                    }
                });
            });
        }

        // 渲染图片匹配列表
        function renderImageMatchList() {
            const container = document.getElementById('imageMatchList');
            const countElement = document.getElementById('imageCount');
            
            // 更新计数
            countElement.textContent = `(${matchState.currentImageFiles.length})`;
            
            // 读取图片并生成预览
            if (matchState.currentImageFiles.length > 0) {
                // 先显示占位符
                container.innerHTML = '<div style="color: var(--light-purple); text-align: center; padding: 20px;">正在加载图片...</div>';
                
                // 异步加载所有图片
                loadAllImages().then(() => {
                    // 生成图片列表
                    container.innerHTML = matchState.currentImageFiles.map((imageData, index) => {
                        const isSelected = matchState.selectedImageIndex === index;
                        return `
                            <div class="image-match-item ${isSelected ? 'selected' : ''}" data-index="${index}">
                                <div class="image-match-preview">
                                    <img src="${imageData.dataUrl}" alt="${imageData.name}">
                                </div>
                                <div class="image-match-name">${imageData.name}</div>
                            </div>
                        `;
                    }).join('');
                    
                    // 添加事件监听器
                    container.querySelectorAll('.image-match-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const index = parseInt(this.dataset.index);
                            selectImageForMatch(index);
                        });
                    });
                });
            } else {
                container.innerHTML = '<div style="color: var(--light-purple); text-align: center; padding: 20px;">暂无图片</div>';
            }
        }

        // 渲染图片选择网格
        function renderImageSelectGrid() {
            const container = document.getElementById('imageSelectGrid');
            
            container.innerHTML = matchState.currentImageFiles.map((imageData, index) => {
                const isSelected = matchState.selectedImageIndex === index;
                return `
                    <div class="image-select-item ${isSelected ? 'selected' : ''}" data-index="${index}">
                        <div class="image-select-preview">
                            <img src="${imageData.dataUrl}" alt="${imageData.name}">
                        </div>
                        <div class="image-select-name">${imageData.name}</div>
                    </div>
                `;
            }).join('');
            
            // 添加事件监听器
            container.querySelectorAll('.image-select-item').forEach(item => {
                item.addEventListener('click', function() {
                    // 清除之前的选择
                    document.querySelectorAll('.image-select-item.selected').forEach(selected => {
                        selected.classList.remove('selected');
                    });
                    
                    // 设置当前选择
                    this.classList.add('selected');
                    matchState.selectedImageIndex = parseInt(this.dataset.index);
                });
            });
        }

        // 加载所有图片
        async function loadAllImages() {
            const imagePromises = matchState.currentImageFiles.map((file, index) => {
                return readImageAsBase64(file);
            });
            
            const imageDataArray = await Promise.all(imagePromises);
            matchState.currentImageFiles = imageDataArray;
        }

        // 选择角色进行匹配
        function selectCharacterForMatch(characterId) {
            matchState.selectedCharacterId = characterId;
            
            // 更新UI
            document.querySelectorAll('.character-match-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.id === characterId);
            });
        }

        // 选择图片进行匹配
        function selectImageForMatch(imageIndex) {
            if (matchState.selectedCharacterId) {
                // 为当前选中的角色设置图片
                const imageData = matchState.currentImageFiles[imageIndex];
                matchState.characterMatches.set(matchState.selectedCharacterId, imageData);
                
                // 更新角色列表显示
                const characterItem = document.querySelector(`.character-match-item[data-id="${matchState.selectedCharacterId}"]`);
                if (characterItem) {
                    const avatar = characterItem.querySelector('.character-match-avatar');
                    const selectBtn = characterItem.querySelector('.character-match-select');
                    
                    avatar.innerHTML = `<img src="${imageData.dataUrl}" alt="已匹配图片">`;
                    selectBtn.textContent = '更换图片';
                }
                
                // 清除选择
                matchState.selectedImageIndex = null;
                document.querySelectorAll('.image-match-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
            } else {
                // 只是选中图片，不匹配
                matchState.selectedImageIndex = imageIndex;
                
                // 更新UI
                document.querySelectorAll('.image-match-item').forEach(item => {
                    item.classList.toggle('selected', parseInt(item.dataset.index) === imageIndex);
                });
            }
        }

        // 确认图片选择
        function confirmImageSelection() {
            if (matchState.selectedCharacterId && matchState.selectedImageIndex !== null) {
                const imageData = matchState.currentImageFiles[matchState.selectedImageIndex];
                matchState.characterMatches.set(matchState.selectedCharacterId, imageData);
                
                // 更新角色列表
                renderCharacterMatchList();
                
                // 隐藏图片选择模态框
                hideImageSelectModal();
                
                // 重新选中角色
                selectCharacterForMatch(matchState.selectedCharacterId);
            }
        }

        // 设置角色筛选
        function setCharacterFilter(filter) {
            matchState.currentFilter = filter;
            
            // 更新筛选按钮
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // 重新渲染角色列表
            renderCharacterMatchList();
        }

        // 应用角色匹配
        function applyCharacterMatches() {
            if (matchState.characterMatches.size === 0) {
                showMessage('没有进行任何匹配', 'warning');
                return;
            }
            
            let updatedCount = 0;
            
            // 更新普通角色
            state.characters.forEach(character => {
                if (matchState.characterMatches.has(character.id)) {
                    const imageData = matchState.characterMatches.get(character.id);
                    character.image = imageData.dataUrl;
                    updatedCount++;
                }
            });
            
            // 更新隐藏角色
            state.hiddenCharacters.forEach(character => {
                if (matchState.characterMatches.has(character.id)) {
                    const imageData = matchState.characterMatches.get(character.id);
                    character.image = imageData.dataUrl;
                    updatedCount++;
                }
            });
            
            // 更新显示和存储
            renderCharacters();
            updateHiddenCharacters();
            renderTeams();
            saveToLocalStorage();
            
            // 隐藏匹配界面
            hideManualMatch();
            
            showMessage(`成功为 ${updatedCount} 个角色更新了图片`);
        }

        // 设置事件委托
        function setupEventDelegation() {
            // 处理"我的角色"区域的事件
            document.getElementById('myCharacters').addEventListener('click', function(e) {
                handleCardButtonClick(e, false);
            });
            
            // 处理"隐藏角色"区域的事件
            document.getElementById('hiddenCharacters').addEventListener('click', function(e) {
                handleCardButtonClick(e, true);
            });
            
            // 处理"配队区域"的事件
            document.getElementById('teamSlots').addEventListener('click', function(e) {
                handleTeamSlotButtonClick(e);
            });
            
            // 处理角色评价展开/折叠
            document.addEventListener('click', function(e) {
                const toggleBtn = e.target.closest('.card-review-toggle');
                if (toggleBtn) {
                    e.stopPropagation();
                    const id = toggleBtn.dataset.id;
                    toggleReviewPopup(id);
                } else if (!e.target.closest('.card-review-popup')) {
                    // 点击其他地方关闭所有评价框
                    closeAllReviewPopups();
                }
            });
        }

        // 处理卡片按钮点击
        function handleCardButtonClick(e, isHidden) {
            // 查找点击的按钮
            const button = e.target.closest('.card-action-btn');
            if (!button) return;
            
            e.stopPropagation();
            const card = button.closest('.character-card');
            if (!card) return;
            
            const id = card.dataset.id;
            const action = button.dataset.action;
            
            switch(action) {
                case 'edit':
                    editCharacter(id);
                    break;
                case 'delete':
                    deleteCharacter(id);
                    break;
                case 'hide':
                case 'show':
                    toggleCharacterHidden(id);
                    break;
            }
        }

        // 处理队伍槽位按钮点击
        function handleTeamSlotButtonClick(e) {
            // 查找点击的按钮
            const button = e.target.closest('.card-action-btn');
            if (!button) return;
            
            e.stopPropagation();
            const card = button.closest('.character-card');
            if (!card) return;
            
            const id = card.dataset.id;
            const action = button.dataset.action;
            
            if (action === 'remove-from-team') {
                removeFromTeam(id);
            }
        }

        // 切换评价弹出框
        function toggleReviewPopup(id) {
            const popup = document.getElementById(`review-popup-${id}`);
            if (!popup) return;
            
            const toggleBtn = document.querySelector(`.card-review-toggle[data-id="${id}"]`);
            
            // 如果当前弹出框已经展开，则关闭它
            if (popup.classList.contains('expanded')) {
                popup.classList.remove('expanded');
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('i');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            } else {
                // 关闭所有其他弹出框
                closeAllReviewPopups();
                
                // 展开当前弹出框
                popup.classList.add('expanded');
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('i');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            }
        }

        // 关闭所有评价弹出框
        function closeAllReviewPopups() {
            document.querySelectorAll('.card-review-popup.expanded').forEach(popup => {
                popup.classList.remove('expanded');
                
                // 恢复按钮图标
                const id = popup.id.replace('review-popup-', '');
                const toggleBtn = document.querySelector(`.card-review-toggle[data-id="${id}"]`);
                if (toggleBtn) {
                    const icon = toggleBtn.querySelector('i');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            });
        }

        // 检查必填字段
        function checkRequiredFields() {
            const name = document.getElementById('characterName').value.trim();
            const stars = document.getElementById('characterStars').value;
            const pve = document.getElementById('characterPve').value;
            const pvp = document.getElementById('characterPvp').value;
            const button = document.getElementById('createButton');
            
            if (name && stars !== '' && pve !== '' && pvp !== '') {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        }

        // 创建或更新角色
        function createOrUpdateCharacter() {
            const id = state.editingCharacterId || Date.now().toString();
            const name = document.getElementById('characterName').value.trim();
            const stars = parseInt(document.getElementById('characterStars').value);
            const pve = parseInt(document.getElementById('characterPve').value);
            const pvp = parseInt(document.getElementById('characterPvp').value);
            const review = document.getElementById('characterReview').value.trim();
            const imagePreview = document.getElementById('imagePreview');
            
            // 如果没有上传图片，使用默认图片
            let characterImage = DEFAULT_IMAGE_PATH;
            if (imagePreview.style.display === 'block' && imagePreview.src) {
                characterImage = imagePreview.src;
            }
            
            // 如果是编辑模式，保留原图（如果没有上传新图）
            if (state.editingCharacterId && !imagePreview.src) {
                const oldChar = state.characters.find(c => c.id === state.editingCharacterId) ||
                               state.hiddenCharacters.find(c => c.id === state.editingCharacterId);
                if (oldChar) characterImage = oldChar.image;
            }
            
            const character = {
                id,
                name,
                stars,
                pve,
                pvp,
                review,
                image: characterImage,
                hidden: false
            };
            
            if (state.editingCharacterId) {
                // 更新现有角色
                const index = state.characters.findIndex(c => c.id === state.editingCharacterId);
                const hiddenIndex = state.hiddenCharacters.findIndex(c => c.id === state.editingCharacterId);
                
                if (index !== -1) {
                    state.characters[index] = character;
                } else if (hiddenIndex !== -1) {
                    state.hiddenCharacters[hiddenIndex] = character;
                }
                
                state.editingCharacterId = null;
                document.getElementById('createButton').textContent = '创建角色';
                showMessage('角色修改成功');
            } else {
                // 添加新角色
                state.characters.push(character);
                showMessage('角色创建成功');
            }
            
            // 清空表单
            clearForm();
            
            // 更新显示和存储
            renderCharacters();
            updateHiddenCharacters();
            saveToLocalStorage();
            updateHiddenCount();
        }

        // 清空表单
        function clearForm() {
            document.getElementById('characterName').value = '';
            document.getElementById('characterStars').value = '';
            document.getElementById('characterPve').value = '';
            document.getElementById('characterPvp').value = '';
            document.getElementById('characterReview').value = '';
            
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            
            document.getElementById('imageInput').value = '';
            
            state.editingCharacterId = null;
            document.getElementById('createButton').textContent = '创建角色';
            checkRequiredFields();
        }

        // 编辑角色
        function editCharacter(id) {
            const character = state.characters.find(c => c.id === id) || 
                            state.hiddenCharacters.find(c => c.id === id);
            
            if (!character) return;
            
            document.getElementById('characterName').value = character.name;
            document.getElementById('characterStars').value = character.stars;
            document.getElementById('characterPve').value = character.pve;
            document.getElementById('characterPvp').value = character.pvp;
            document.getElementById('characterReview').value = character.review || '';
            
            if (character.image && character.image !== DEFAULT_IMAGE_PATH) {
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = character.image;
                imagePreview.style.display = 'block';
            } else {
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
            
            state.editingCharacterId = id;
            document.getElementById('createButton').textContent = '修改角色';
            checkRequiredFields();
            
            // 滚动到表单
            document.querySelector('.section-container').scrollIntoView({ behavior: 'smooth' });
        }

        // 删除角色
        function deleteCharacter(id) {
            if (!confirm('确定要删除这个角色吗？')) return;
            
            // 从角色列表中删除
            state.characters = state.characters.filter(c => c.id !== id);
            state.hiddenCharacters = state.hiddenCharacters.filter(c => c.id !== id);
            
            // 从所有队伍中删除
            for (let i = 0; i < state.teams.length; i++) {
                state.teams[i] = state.teams[i].filter(charId => charId !== id);
            }
            
            // 更新显示和存储
            renderCharacters();
            updateHiddenCharacters();
            renderTeams();
            saveToLocalStorage();
            updateHiddenCount();
            
            showMessage('角色删除成功');
        }

        // 隐藏/显示角色
        function toggleCharacterHidden(id) {
            const charIndex = state.characters.findIndex(c => c.id === id);
            const hiddenIndex = state.hiddenCharacters.findIndex(c => c.id === id);
            
            if (charIndex !== -1) {
                // 从正常列表移到隐藏列表
                const character = state.characters[charIndex];
                character.hidden = true;
                state.hiddenCharacters.push(character);
                state.characters.splice(charIndex, 1);
                showMessage('角色已隐藏');
            } else if (hiddenIndex !== -1) {
                // 从隐藏列表移到正常列表
                const character = state.hiddenCharacters[hiddenIndex];
                character.hidden = false;
                state.characters.push(character);
                state.hiddenCharacters.splice(hiddenIndex, 1);
                showMessage('角色已恢复显示');
            }
            
            // 从所有队伍中删除
            for (let i = 0; i < state.teams.length; i++) {
                state.teams[i] = state.teams[i].filter(charId => charId !== id);
            }
            
            // 更新显示和存储
            renderCharacters();
            updateHiddenCharacters();
            renderTeams();
            saveToLocalStorage();
            updateHiddenCount();
        }

        // 渲染角色卡片
        function renderCharacters() {
            const container = document.getElementById('myCharacters');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // 过滤和排序角色
            let filteredCharacters = state.characters.filter(character => 
                character.name.toLowerCase().includes(searchTerm)
            );
            
            // 应用排序
            filteredCharacters = sortCharacters(filteredCharacters);
            
            // 生成卡片HTML
            container.innerHTML = filteredCharacters.map(character => 
                createCharacterCardHTML(character, false)
            ).join('');
            
            // 重新绑定拖拽事件
            attachDragEvents(false);
        }

        // 更新隐藏的角色
        function updateHiddenCharacters() {
            const container = document.getElementById('hiddenCharacters');
            
            container.innerHTML = state.hiddenCharacters.map(character => 
                createCharacterCardHTML(character, true)
            ).join('');
            
            // 重新绑定拖拽事件
            attachDragEvents(true);
        }

        // 创建角色卡片HTML
        function createCharacterCardHTML(character, isHidden) {
            // 生成6颗星星，根据星级填充
            const maxStars = 6;
            const starsHTML = Array(maxStars).fill(0).map((_, i) => {
                if (i < character.stars) {
                    return `<i class="fas fa-star star-icon filled"></i>`;
                } else {
                    return `<i class="fas fa-star star-icon"></i>`;
                }
            }).join('');
            
            const isInTeam = state.teams.some(team => team.includes(character.id));
            const cardClass = isHidden ? 'character-card hidden-card' : 'character-card';
            const hideShowBtn = isHidden ? 
                '<button class="card-action-btn show-btn" data-action="show" title="显示"><i class="fas fa-eye"></i></button>' :
                '<button class="card-action-btn hide-btn" data-action="hide" title="隐藏"><i class="fas fa-eye-slash"></i></button>';
            
            // 检查是否使用默认图片
            const useDefaultImage = !character.image || character.image === DEFAULT_IMAGE_PATH;
            
            return `
                <div class="${cardClass}" data-id="${character.id}" draggable="true" data-in-team="${isInTeam}">
                    <div class="card-actions">
                        <button class="card-action-btn edit-btn" data-action="edit" title="修改"><i class="fas fa-edit"></i></button>
                        <button class="card-action-btn delete-btn" data-action="delete" title="删除"><i class="fas fa-trash"></i></button>
                        ${hideShowBtn}
                    </div>
                    <div class="card-image-container">
                        ${useDefaultImage ? 
                            `<img src="${DEFAULT_IMAGE_PATH}" alt="${character.name}" class="card-image">` :
                            `<img src="${character.image}" alt="${character.name}" class="card-image">`
                        }
                    </div>
                    <div class="card-content">
                        <h3 class="card-name">${character.name}</h3>
                        <div class="card-stars">
                            ${starsHTML}
                        </div>
                        <div class="card-scores">
                            <span class="pve-score">PVE评分: ${character.pve}</span>
                            <span class="pvp-score">PVP评分: ${character.pvp}</span>
                        </div>
                        <button class="card-review-toggle" data-id="${character.id}">
                            <span>角色评价</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    
                    <!-- 角色评价弹出框 -->
                    <div class="card-review-popup" id="review-popup-${character.id}">
                        <div class="card-review-content">
                            ${character.review || '暂无评价'}
                        </div>
                    </div>
                </div>
            `;
        }

        // 绑定拖拽事件
        function attachDragEvents(isHidden) {
            const container = isHidden ? 
                document.getElementById('hiddenCharacters') : 
                document.getElementById('myCharacters');
            
            if (!container) return;
            
            // 卡片拖拽
            container.querySelectorAll('.character-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
            });
        }

        // 排序角色
        function sortCharacters(characters) {
            if (!state.currentSort) return characters;
            
            return [...characters].sort((a, b) => {
                let aVal, bVal;
                
                switch(state.currentSort) {
                    case 'stars':
                        aVal = a.stars;
                        bVal = b.stars;
                        break;
                    case 'pve':
                        aVal = a.pve;
                        bVal = b.pve;
                        break;
                    case 'pvp':
                        aVal = a.pvp;
                        bVal = b.pvp;
                        break;
                    default:
                        return 0;
                }
                
                return state.sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });
        }

        // 切换排序
        function toggleSort(sortType) {
            const buttons = document.querySelectorAll('.sort-btn');
            
            if (state.currentSort === sortType) {
                // 取消排序
                state.currentSort = null;
                buttons.forEach(btn => btn.classList.remove('active'));
            } else {
                // 应用新排序
                state.currentSort = sortType;
                state.sortDirection = 'desc';
                buttons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.sort === sortType);
                });
            }
            
            renderCharacters();
        }

        // 队伍管理
        function switchTeam(teamNum) {
            state.currentTeam = teamNum;
            
            // 更新标签
            document.querySelectorAll('.team-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.team) === teamNum);
            });
            
            // 渲染队伍
            renderTeams();
        }

        // 渲染队伍
        function renderTeams() {
            const slots = document.querySelectorAll('.team-slot');
            const currentTeam = state.teams[state.currentTeam - 1];
            
            // 清空所有位置
            slots.forEach(slot => {
                slot.innerHTML = '<div class="slot-placeholder"><i class="fas fa-user-plus"></i><p>拖拽角色卡片到这里</p></div>';
            });
            
            // 填充当前队伍的角色
            currentTeam.forEach((characterId, index) => {
                if (index >= 4) return;
                
                const character = state.characters.find(c => c.id === characterId) || 
                                state.hiddenCharacters.find(c => c.id === characterId);
                
                if (character) {
                    const slot = slots[index];
                    slot.innerHTML = createCharacterCardHTML(character, false);
                    
                    // 添加移除功能
                    const card = slot.querySelector('.character-card');
                    if (card) {
                        card.draggable = true;
                        card.addEventListener('dragstart', handleDragStart);
                        
                        // 修改操作按钮（只能移除）
                        const actions = card.querySelector('.card-actions');
                        if (actions) {
                            actions.innerHTML = `
                                <button class="card-action-btn delete-btn" data-action="remove-from-team" title="从队伍移除">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }
                    }
                }
            });
        }

        // 清空当前队伍
        function clearCurrentTeam() {
            if (state.teams[state.currentTeam - 1].length === 0) return;
            
            if (!confirm('确定要清空当前队伍吗？')) return;
            
            state.teams[state.currentTeam - 1] = [];
            renderTeams();
            renderCharacters();
            updateHiddenCharacters();
            saveToLocalStorage();
            showMessage('队伍已清空');
        }

        // 从队伍中移除角色
        function removeFromTeam(characterId) {
            state.teams[state.currentTeam - 1] = state.teams[state.currentTeam - 1].filter(id => id !== characterId);
            renderTeams();
            renderCharacters();
            updateHiddenCharacters();
            saveToLocalStorage();
            showMessage('角色已从队伍中移除');
        }

        // 拖拽功能
        function setupDragAndDrop() {
            const slots = document.querySelectorAll('.team-slot');
            
            slots.forEach(slot => {
                slot.addEventListener('dragover', handleDragOver);
                slot.addEventListener('dragenter', handleDragEnter);
                slot.addEventListener('dragleave', handleDragLeave);
                slot.addEventListener('drop', handleDrop);
            });
            
            // 我的角色区域也可以接收拖拽（用于从队伍中移除）
            const myCharactersArea = document.getElementById('myCharacters');
            if (myCharactersArea) {
                myCharactersArea.addEventListener('dragover', handleDragOver);
                myCharactersArea.addEventListener('drop', handleDropToMyCharacters);
            }
        }

        // 拖拽开始
        function handleDragStart(e) {
            const card = e.target.closest('.character-card');
            if (card) {
                e.dataTransfer.setData('text/plain', card.dataset.id);
                e.dataTransfer.effectAllowed = 'move';
            }
        }

        // 拖拽经过
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        // 拖拽进入
        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drop-over');
        }

        // 拖拽离开
        function handleDragLeave(e) {
            this.classList.remove('drop-over');
        }

        // 放置到队伍位置
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drop-over');
            
            const characterId = e.dataTransfer.getData('text/plain');
            if (!characterId) return;
            
            const slotIndex = parseInt(this.dataset.slot) - 1;
            const currentTeam = state.teams[state.currentTeam - 1];
            
            // 检查是否已在队伍中
            if (currentTeam.includes(characterId)) {
                showMessage('该角色已在队伍中！', 'warning');
                return;
            }
            
            // 检查位置是否已被占用
            if (currentTeam[slotIndex]) {
                // 替换位置
                currentTeam[slotIndex] = characterId;
            } else {
                // 添加到位置
                currentTeam[slotIndex] = characterId;
            }
            
            renderTeams();
            renderCharacters();
            updateHiddenCharacters();
            saveToLocalStorage();
            showMessage('角色已加入队伍');
        }

        // 放置到我的角色区域（从队伍中移除）
        function handleDropToMyCharacters(e) {
            e.preventDefault();
            const characterId = e.dataTransfer.getData('text/plain');
            
            if (!characterId) return;
            
            // 从所有队伍中移除
            for (let i = 0; i < state.teams.length; i++) {
                state.teams[i] = state.teams[i].filter(id => id !== characterId);
            }
            
            renderTeams();
            renderCharacters();
            updateHiddenCharacters();
            saveToLocalStorage();
            showMessage('角色已从队伍中移除');
        }

        // 更新隐藏角色计数
        function updateHiddenCount() {
            const hiddenCount = document.getElementById('hiddenCount');
            if (hiddenCount) {
                hiddenCount.textContent = state.hiddenCharacters.length;
            }
        }

        // 导出数据
        function exportData() {
            const data = {
                characters: state.characters,
                hiddenCharacters: state.hiddenCharacters,
                teams: state.teams,
                currentTeam: state.currentTeam,
                exportDate: new Date().toISOString(),
                version: '1.5.0',
                appName: '欲神幻想梯度榜',
                exportNote: '使用"导入数据"功能可以恢复此文件中的数据'
            };
            
            // 生成文件名：欲神幻想梯度榜数据+日期
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const filename = `欲神幻想梯度榜数据${year}年${month}月${day}日${hours}时${minutes}分.json`;
            
            // 创建下载链接
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`数据已导出为：${filename}`);
        }

        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 确认是否覆盖现有数据
            if (state.characters.length > 0 || state.hiddenCharacters.length > 0) {
                if (!confirm('导入数据将覆盖现有数据，确定继续吗？')) {
                    event.target.value = '';
                    return;
                }
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if (!jsonData.characters || !jsonData.teams) {
                        throw new Error('文件格式不正确，请选择正确的数据文件');
                    }
                    
                    // 检查是否是欲神幻想梯度榜的数据文件
                    if (!jsonData.appName || !jsonData.appName.includes('欲神幻想梯度榜')) {
                        if (!confirm('检测到这不是欲神幻想梯度榜的数据文件，可能无法正确导入。是否继续？')) {
                            event.target.value = '';
                            return;
                        }
                    }
                    
                    // 更新状态
                    state.characters = jsonData.characters || [];
                    state.hiddenCharacters = jsonData.hiddenCharacters || [];
                    state.teams = jsonData.teams || [[], [], [], []];
                    state.currentTeam = jsonData.currentTeam || 1;
                    
                    // 更新显示
                    renderCharacters();
                    updateHiddenCharacters();
                    renderTeams();
                    updateHiddenCount();
                    
                    // 保存到本地存储
                    saveToLocalStorage();
                    
                    showMessage('数据导入成功！');
                    
                } catch (error) {
                    console.error('导入失败:', error);
                    showMessage('导入失败：文件格式不正确或已损坏', 'error');
                }
                
                // 清空文件输入
                event.target.value = '';
            };
            
            reader.onerror = function() {
                showMessage('读取文件失败，请重试', 'error');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // 本地存储
        function saveToLocalStorage() {
            const data = {
                characters: state.characters,
                hiddenCharacters: state.hiddenCharacters,
                teams: state.teams,
                currentTeam: state.currentTeam,
                lastSave: new Date().toISOString()
            };
            localStorage.setItem('yshx-character-data', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('yshx-character-data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    state.characters = data.characters || [];
                    state.hiddenCharacters = data.hiddenCharacters || [];
                    state.teams = data.teams || [[], [], [], []];
                    state.currentTeam = data.currentTeam || 1;
                    
                    // 显示上次保存时间
                    if (data.lastSave) {
                        const lastSave = new Date(data.lastSave);
                        console.log(`数据已从本地存储加载，上次保存时间：${lastSave.toLocaleString('zh-CN')}`);
                    }
                } catch (error) {
                    console.error('加载本地存储数据失败:', error);
                    // 如果解析失败，使用默认值
                    state.characters = [];
                    state.hiddenCharacters = [];
                    state.teams = [[], [], [], []];
                    state.currentTeam = 1;
                }
            } else {
                // 初始化为空
                state.characters = [];
                state.hiddenCharacters = [];
                state.teams = [[], [], [], []];
                state.currentTeam = 1;
            }
        }
    </script>
</body>
</html>